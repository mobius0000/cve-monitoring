#!/usr/bin/env python3.6
# coding:utf-8

#===============================================================================
#
#          FILE: main.sh
# 
#         USAGE: ./main.sh 
# 
#   DESCRIPTION: 
# 
#       OPTIONS: ---
#  REQUIREMENTS: ---
#          BUGS: ---
#         NOTES: ---
#        AUTHOR: möbius (), 
#  ORGANIZATION: 
#       CREATED: 08/08/2019 16:29
#      REVISION:  ---
#===============================================================================

import sys
import json
from elasticsearch import Elasticsearch

es = Elasticsearch("127.0.0.1:9200")


def main():

    '''
        Main 
    '''

    indexName = 'ts-cve'
    try:
        cveFile = sys.argv[1]
    except:
        print("No cvefile")

    # check / create Elasticsearch's index
    if es.indices.exists(indexName) is False:
        cveIndex = open('cveIndex.json')
        cveIndex = json.load(cveIndex)
        es.indices.create(indexName,body=cveIndex)
    else:
        pass

    cveImported = open(cveFile)
    cveImported = json.load(cveImported)

    for i in cveImported['CVE_Items']:
        cve=i['cve']
        cveId = cve['CVE_data_meta']['ID']
        cve.update(i['impact'])
        cve['year'] = cveId.split('-')[1]
        es.update(id=cveId, index=indexName, body={ 'doc': cve, 'doc_as_upsert': True})


if __name__ == '__main__':
    main()
